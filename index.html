<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Posters Session X
    </title>

    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <!-- Style for the index left bar, to make it scrollable rather than col-4 -->
  <!-- This involves icky fixed height.  % height doesn't work, don't know why -->
  <style>
  .indexBox 
  {
    height:100pc;
    width:33%;
    overflow:scroll;
    background-color:#f1f1f1;
  }
  </style>

  </head>

  <body>

    <!-- Neutrino logo and page header -->
    <div class="container-fluid p-0 border-bottom">
      <div class="row">
        <div class="col-12">
          <nav class="navbar navbar-dark bg-dark">
            <span class="navbar-brand mb-0 h1">
              <img src="img/webimg/Nu2020.png" style="max-width: 200pt;">
              Poster Session X
            </span>
          </nav>
        </div>
      </div>
    </div>

    <!-- Body.  We want an index left, and one poster's details right -->
    <div class="container-fluid mt-5">
      <div class="row">

	<!-- Column for Index Display -->
        <div class="indexBox text-center border-left">
	  <p>
	    <button class="ajax-tippy" onclick="Cycle(1,0)">
              <i class="fa fa-sync-alt"></i> See a random poster
	    </button>
	  </p>

	  <!-- The actual index: html is built up by script buildIndex() -->
          <h4><strong>Session Index</strong></h4> 
	  <div id=posterIndex></div>
        </div>
	
        <!-- Column for Video and Poster Display -->
        <div class="col-8 text-center border-left">
	  <h3>
	    <div id=posterID></div>
	    <a id="presentLink"><span class="badge badge-info">Click here during the poster session to get to the presentation</span></a>
	  </h3>
	  <h3><strong><div id=posterTitle></div></strong></h3>
	  <h4><div id=authors></div></h4>
	  <h4><div id=collaboration></div></h4>
	  <h4><em><div id=miniAbstract></div></em></h4>
          <!-- was 560x315 -->
	  <iframe id=videoLink width="720" height="405" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
	  <a id="pdf"><img id="poster" style="max-width: 0.9column-width;"></a>
 	  <br>
        </div>
      </div>


      <!-- Footer -->
      <div class="row">
        <div class="col-12 text-center">
          <h5>
            Created and maintained by THE POWERS THAT BE (<a href="mailto:nu2020-posters@fnal.gov">nu2020-posters@fnal.gov</a>).
          </h5>
        </div>
      </div>
      
    </div>

    <!-- Page-specific javascript -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script src="js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.js"></script>  
    <script>
      // Our scripts, rather than the libraries loaded above

      // Display a random thing in the array
      function DisplayRandomEVD(evds)
      {
        currentEVD = evds[Math.floor(Math.random() * evds.length)];
        DisplayEVD(currentEVD);
      }

      // Display a particular thing in the array
      function DisplaySomeEVD(evds,whichOne)
      {
        currentEVD = evds[whichOne];
        DisplayEVD(currentEVD);
      }

      // Set up the element ID's to be displayed, pulling from the 
      // item passed in
      function DisplayEVD(currentEVD)
      {
        $('#posterID').html('Poster #' + currentEVD.posterID);
        $('img#poster').attr('src', currentEVD.filename);
        $('a#pdf').attr('href',currentEVD.pdfname);
        $('a#presentLink').attr('href',currentEVD.presentLink);
        $('#posterTitle').html(currentEVD.posterTitle);
        $('#miniAbstract').html(currentEVD.miniAbstract);
        // need some logic to add commas etc
        if (currentEVD.otherNames.length > 0) {
          $('#authors').html(currentEVD.authorName + ', ' + currentEVD.otherNames);
        } else {
          $('#authors').html(currentEVD.authorName);
        }
        if (currentEVD.collaboration.length > 0) {
          $('#collaboration').html('for ' + currentEVD.collaboration);
        } else {
          $('#collaboration').html('');
        }
        $('iframe#videoLink').attr('src', currentEVD.videoLink);
      }

      // Build an index element
      function buildIndex(evds)
      {
        // indexString is the collection of html we're building
        // i is an index
        var indexString="", i=0;
        // build a block of html for each poster in the index, by building up 
        // a string.  This is messy.  Each poster should probably be an
        // element of some sort, but this is a start
        for (i=0; i<evds.length; i++)
	{
	 // Make a button
	 indexString += "<button class=\"ajax-tippy\" onclick=\"Cycle(0,"+ i + ")\" data-thumbnail=\"" + evds[i].smallFilename + "\" ><i class=\"fa fa-sync-alt\"></i>";
	 indexString += " Poster #" + evds[i].posterID + ' ';
	 indexString += "</button>";

         // Show the title
	 indexString +="<p><strong>" + evds[i].posterTitle + "</strong><br>";

         // Show the author
         indexString += "<em>" + evds[i].authorName + "</em></p>";	 

         // Show a thumbnail
         // indexString += "<img src=\"" + evds[i].smallFilename + "\" onclick=\"Cycle(0,"+ i + ")\"><br><hr>";	 

	}
	$('#posterIndex').html(indexString);
      }

      // hover over code for things in #posterIndex of class .ajax-tippy
      tippy.delegate('#posterIndex', {
	target: '.ajax-tippy',
	content: 'Loading...',
	placement: 'right',
	onCreate(instance) {
	  // Setup our own custom state properties
          instance._isFetching = false;
          instance._src = null;
          instance._error = null;
        },

//	content(reference) {
//	  return reference.getAttribute('data-thumbnail');
//        },

	onShow(instance) {
          // Code here is executed every time the tippy shows

	  // if we're not already trying fetch the image
	  if (instance._isFetching || instance._src || instance._error) {
            return;
          }
	  instance._isFetching = true;
	  var thumbnailName = instance.reference.getAttribute('data-thumbnail');
          fetch(thumbnailName)
//          fetch('https://unsplash.it/200/?random')
            .then((response) => response.blob())
	    .then((blob) => {
            // Convert the blob into a URL
            const url = URL.createObjectURL(blob);
            // Create an image
            const image = new Image();
//            image.width = 200;
//            image.height = 200;
            image.style.display = 'block';
            image.src = url;
            // Update the tippy content with the image
            instance.setContent(image);
          })
          .catch((error) => {
            // Fallback if the network request failed
	    instance._error = error;
            instance.setContent(`Request failed. ${error}`);
          })
          .finally(() => {
            instance._isFetching = false;
          });
        },

        onHidden(instance) {
	  // do this once it falls back out of scope: re-init stuff
          instance.setContent('Loading...');
	  // Unset these properties so new network requests can be initiated
	  instance._src = null;
	  instance._error = null;        
	},
      });

      // Reload data, display a random one if random is true, else thisOne
      function Cycle(random,thisOne)
      {
        // Perform Ajax request, fetch posters.json
        $.ajax({
            url: 'data/posters.json',
            type: 'get',
            success: function(respose){
	      buildIndex(respose);
              if (random) { DisplayRandomEVD(respose);}
              else {DisplaySomeEVD(respose,thisOne);}
            },
            error: function (xhr, ajaxOptions, thrownError) {
              console.log('An error occurred :(');
            }
        });
      }

      // When the page has loaded, execute everything inside the function()
      $( document ).ready(function(){
        currentEVD = {}
        Cycle(1,0);
      });
    </script>

  </body>
</html>
